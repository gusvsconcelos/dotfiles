#!/usr/bin/env bash

GIB=1048576 

ESC="\033"
reset="${ESC}[0m"

magenta="${ESC}[1;35m"
green="${ESC}[1;32m"
white="${ESC}[1;37m"
blue="${ESC}[1;34m"
red="${ESC}[1;31m"
yellow="${ESC}[1;33m"
cyan="${ESC}[1;36m"
black="${ESC}[1;40;30m"

bgyellow="${ESC}[1;43;33m"
bgwhite="${ESC}[1;47;37m"

c0="$reset"
c1="$magenta"
c2="$green"
c3="$white"
c4="$blue"
c5="$red"
c6="$yellow"
c7="$cyan"
c8="$black"
c9="$bgyellow"
c10="$bgwhite"

USER="${USER:-$(id -un 2>/dev/null || echo user)}"
HOST="$(hostname 2>/dev/null || cat /etc/hostname 2>/dev/null || echo unknown)"
USER="$(whoami)"
KERNEL="$(uname -r)"
SHELL_NAME="${SHELL##*/}"

cmd() { command -v "$1" >/dev/null 2>&1; }

get_init() {
	if [[ "$OS" == "Android" ]]; then
		echo "init.rc"
	elif pidof systemd >/dev/null 2>&1; then
		echo "systemd"
	elif [[ -x /sbin/openrc ]]; then
		echo "openrc"
	else
		cut -d' ' -f1 /proc/1/comm 2>/dev/null
	fi
}

get_distro() {
	if [[ "$OS" == "Android" ]]; then
		echo "Android"
	else
		awk -F\" '/PRETTY_NAME/{print $2}' /etc/os-release 2>/dev/null
	fi
}

get_pkg_count() {
	local pm
	for pm in xbps-install apk apt pacman nix dnf rpm emerge; do
		cmd "$pm" || continue
		case "$pm" in
			xbps-install) xbps-query -l | wc -l ;;
			apk) apk search | wc -l ;;
			apt) echo $(( $(apt list --installed 2>/dev/null | wc -l) - 1 )) ;;
			pacman) pacman -Q | wc -l ;;
			nix) nix-env -qa --installed '*' | wc -l ;;
			dnf) dnf list installed | wc -l ;;
			rpm) rpm -qa | wc -l ;;
			emerge) qlist -I | wc -l ;;
		esac
		return
	done
	echo 0
}

get_snap_count() {
	cmd snap || { echo 0; return; }
	echo $(( $(snap list | wc -l) - 1 ))
}

get_flatpak_count() {
	cmd flatpak || { echo 0; return; }
	flatpak list | wc -l
}

get_packages() {
	local pkg snap flat
	pkg="$(get_pkg_count)"
	snap="$(get_snap_count)"
	flat="$(get_flatpak_count)"

	[[ "$pkg" -eq 0 && "$snap" -eq 0 && "$flat" -eq 0 ]] && {
		echo "Unknown"
		return
	}

	printf "%s" "$pkg"
	[[ "$snap" -ne 0 || "$flat" -ne 0 ]] && printf " ("
	[[ "$snap" -ne 0 ]] && printf "%s snaps" "$snap"
	[[ "$snap" -ne 0 && "$flat" -ne 0 ]] && printf ", "
	[[ "$flat" -ne 0 ]] && printf "%s flatpaks" "$flat"
	[[ "$snap" -ne 0 || "$flat" -ne 0 ]] && printf ")"
}

get_cpu() {
	awk -F': ' '/model name/{print $2; exit}' /proc/cpuinfo
}

get_gpu() {
	cmd lspci && lspci | grep -E "VGA|3D" | cut -d':' -f3 | sed 's/^ //'
}

get_mem() {
	awk -v g="$GIB" '
		/MemTotal/ { total = $2 }
		/MemAvailable/ { avail = $2 }
		END {
			used = total - avail
			printf "%.1f / %.1f GiB\n", used/g, total/g
		}
	' /proc/meminfo
}

get_disk() {
	awk -v g="$GIB" '
		NR==2 {
			printf "%.1f / %.1f GiB\n", $3/g, $2/g
		}
	' < <(df -k /)
}

get_uptime() {
	uptime -p | sed 's/up //'
}

get_de_wm() {
	local wm
	wm="${XDG_CURRENT_DESKTOP#*:}"
	[[ "$wm" ]] || wm="$DESKTOP_SESSION"

	[[ ! "$wm" && "$DISPLAY" && $(cmd xprop) ]] && {
		id=$(xprop -root _NET_SUPPORTING_WM_CHECK 2>/dev/null | awk '{print $NF}')
		wm=$(xprop -id "$id" _NET_WM_NAME 2>/dev/null | cut -d\" -f2)
	}

	[[ "$wm" == "LG3D" || -z "$wm" ]] &&
		wm=$(pgrep -m1 -o sway wayfire hyprland dwm xmonad)

	echo "${wm:-unknown}"
}

if [[ "$OS" == "Android" ]]; then
	printf "               %sphone%s  %s %s\n" \
		"$c5" "$c3" \
		"$(getprop ro.product.brand)" \
		"$(getprop ro.product.model)"
fi

clear;
printf "%b\n" "┏━━━━━━━━━━━━━━━━━━━━━┓"
printf "%b\n" "┃ ${c6}f${c4}e${c5}t${c6}${c7}c${c1}h${c0}       ${c6}${c0}  ${c7}${c0}  ${c5}${c0} ┃  ${c1}${USER}${c5}@${c1}${c2}${HOST}${c0}"
printf "%b\n" "┣━━━━━━━━━━━━━━━━━━━━━┫"
printf "%b\n" "┃                     ┃  ${c1}󰌽${c3}  $(get_distro)"
printf "%b\n" "┃         ${c3}•${c8}_${c3}•${c0}         ┃  ${c2}󰠠${c3}  $(echo "$KERNEL" | cut -d'-' -f1)"
printf "%b\n" "┃         ${c8}${c0}${c9}oo${c0}${c8}|${c0}         ┃  ${c7}${c3}  $(get_de_wm)"
printf "%b\n" "┃        ${c8}/${c0}${c10} ${c0}${c8}'\\'${c0}        ┃  ${c4}${c3}  $SHELL_NAME"
printf "%b\n" "┃       ${c9}(${c0}${c8}\_;/${c0}${c9})${c0}        ┃  ${c6}󰏖${c3}  $(get_packages)"
printf "%b\n" "┃                     ┃  ${c5}${c3}  $(get_disk)"
printf "%b\n" "┃                     ┃"
printf "%b\n" "┗━━━━━━━━━━━━━━━━━━━━━┛  ${c1}━━━${c2}━━━${c3}━━━${c4}━━━${c5}━━━${c6}━━━${c7}━━━${c0}"
